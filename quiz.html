<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaker - Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa+Ink:wght@400;700&family=Cairo:wght@400;700;900&family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="dark">

    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="btn btn-secondary" onclick="window.location.href='lecture.html'" style="margin: 0; padding: 8px 15px;">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
            <h1 class="logo" data-i18n="appName" style="font-size: 2rem;">Ø°Ø§ÙƒØ±</h1>
        </div>
        <div class="header-controls">
            <div class="settings-group">
                <button class="icon-btn" onclick="toggleLanguage()" title="Language">ğŸŒ</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Theme">ğŸŒ™</button>
            </div>
            <div id="userProfile" class="hidden user-profile-badge">
                <img id="userImg" src="">
                <span id="userName"></span>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen active">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; max-width: 850px; margin-left: auto; margin-right: auto;">
            <button class="btn btn-secondary" id="soundToggleBtn" onclick="toggleQuizSound()" style="margin: 0; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border);">ğŸ”Š Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„</button>
            <button class="btn btn-danger" onclick="cancelExam()" style="margin: 0;" data-i18n="endExamBtn">âœ–ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</button>
        </div>
        
        <div class="quiz-container">
            <div id="examTimerContainer" class="hidden exam-timer">
                <span data-i18n="timeLabel">â±ï¸ Ø§Ù„ÙˆÙ‚Øª:</span> <span id="examTimerText">00:00</span>
            </div>
            
            <div id="normalNavControls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--input-bg); padding: 10px; border-radius: 10px;">
                <button class="btn btn-secondary" onclick="prevQuestion()">ğŸ”™</button>
                <select id="questionSelect" onchange="jumpToQuestion(this.value)"></select>
                <button class="btn btn-secondary" onclick="nextQuestionNav()">â­ï¸</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span id="quizProgress" style="font-weight: bold; color: var(--primary-color);"></span>
            </div>
            
            <div id="externalAiControls" style="text-align: left; margin-bottom: 15px;">
                <button class="btn-ai chatgpt" onclick="askExternalAI('chatgpt')">ğŸ§  ChatGPT</button>
                <button class="btn-ai gemini" onclick="askExternalAI('gemini')">âœ¨ Gemini</button>
            </div>

            <h3 id="questionText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <div id="options"></div>
            
            <div id="feedback" class="feedback"></div>
            
            <div id="controls" style="margin-top: 30px; display: none; direction: ltr;">
                <button class="btn btn-success" id="nextBtn" onclick="nextQuestion()">Next â­ï¸</button>
                <button class="btn btn-danger" id="tryAgainBtn" onclick="tryAgain()" style="display: none;">ğŸ”„ Try Again</button>
            </div>
        </div>
    </div>

    <div id="examResultScreen" class="screen">
        <div class="quiz-container" style="text-align: center;">
            <h2 data-i18n="finalResultTitle">ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <h1 id="finalScoreText" style="font-size: 4rem; color: var(--primary-color);">0%</h1>
            <p id="examResultMessage" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 30px; line-height: 1.6;"></p>
            <button class="btn btn-primary" onclick="window.location.href='lecture.html'" data-i18n="backToLectureBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="app.js"></script>
    
    <script>
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ Local Storage
        let currentSubjectKey = localStorage.getItem('currentSubjectKey');
        let currentSubjectName = localStorage.getItem('currentSubjectName');
        let currentLectureName = localStorage.getItem('currentLectureName');
        let isExamMode = localStorage.getItem('isExamMode') === 'true';

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
        let currentQIndex = 0;
        let examScore = 0;
        let examTimeLeft = 0;
        let examTimerInterval;
        let questionsList = [];
        
        let audioCtx = null;
        let isSoundEnabled = localStorage.getItem('myUniversityApp_sound') !== 'disabled';

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
        if (!currentSubjectKey || !currentLectureName) {
            window.location.href = 'index.html';
        }

        // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userImg').src = user.photoURL;
                document.getElementById('userName').innerText = user.displayName.split(' ')[0];

                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists) {
                        globalData = doc.data();
                        
                        // ØªØ¬Ù‡ÙŠØ² Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
                        if (!globalData.userProgress) globalData.userProgress = {};
                        if (!globalData.userProgress[currentSubjectKey]) {
                            globalData.userProgress[currentSubjectKey] = { total: 0, correct: 0, wrong: 0 };
                        }
                        
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                        if (globalData.allData && globalData.allData[currentSubjectKey] && globalData.allData[currentSubjectKey][currentLectureName]) {
                            questionsList = globalData.allData[currentSubjectKey][currentLectureName];
                            startQuiz();
                        } else {
                            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.");
                            window.location.href = 'lecture.html';
                        }
                    }
                } catch (e) {
                    console.error("Error loading quiz data", e);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // 3. Ø¯ÙˆØ§Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ù…Ø°Ø§ÙƒØ±Ø©
        function startQuiz() {
            currentQIndex = 0;
            examScore = 0;
            clearInterval(examTimerInterval);
            
            updateSoundBtnUI();

            if (isExamMode) {
                document.getElementById('normalNavControls').style.display = 'none';
                document.getElementById('externalAiControls').style.display = 'none';
                document.getElementById('examTimerContainer').classList.remove('hidden');
                
                // Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
                examTimeLeft = questionsList.length * 60;
                updateTimerDisplay();
                examTimerInterval = setInterval(timerTick, 1000);
            } else {
                document.getElementById('normalNavControls').style.display = 'flex';
                document.getElementById('externalAiControls').style.display = 'block';
                document.getElementById('examTimerContainer').classList.add('hidden');
            }

            loadQuestion();
        }

        function loadQuestion() {
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            const optionsDiv = document.getElementById('options');
            optionsDiv.style.display = 'block';
            optionsDiv.innerHTML = '';

            if (currentQIndex < questionsList.length) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©
                if (!isExamMode && document.getElementById('questionSelect')) {
                    const qSelect = document.getElementById('questionSelect');
                    qSelect.innerHTML = '';
                    questionsList.forEach((q, i) => {
                        let opt = document.createElement('option');
                        opt.value = i;
                        opt.text = `Q ${i + 1}`;
                        if (i === currentQIndex) opt.selected = true;
                        qSelect.appendChild(opt);
                    });
                }

                document.getElementById('quizProgress').innerText = `Question ${currentQIndex + 1} of ${questionsList.length}`;
                const currentQ = questionsList[currentQIndex];
                document.getElementById('questionText').innerText = currentQ.q;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
                if (currentQ.type === "tf") {
                    optionsDiv.innerHTML += `<button class="btn btn-option" onclick="checkAnswer('ØµØ­')">${currentLang==='ar'?'ØµØ­':'True'}</button>`;
                    optionsDiv.innerHTML += `<button class="btn btn-option" onclick="checkAnswer('ØºÙ„Ø·')">${currentLang==='ar'?'ØºÙ„Ø·':'False'}</button>`;
                } else if (currentQ.type === "mcq") {
                    currentQ.options.forEach(opt => {
                        let safeOpt = opt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        optionsDiv.innerHTML += `<button class="btn btn-option" onclick="checkAnswer('${safeOpt}')">${opt}</button>`;
                    });
                }
            } else {
                // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                if (isExamMode) {
                    endExam();
                } else {
                    document.getElementById('quizProgress').innerText = currentLang === 'ar' ? "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" : "Finished";
                    document.getElementById('questionText').innerText = "ğŸ‰ Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!";
                    optionsDiv.style.display = 'none';
                    document.getElementById('normalNavControls').style.display = 'none';
                    document.getElementById('externalAiControls').style.display = 'none';
                }
            }
        }

        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function checkAnswer(userAnswer) {
            const currentQ = questionsList[currentQIndex];
            
            // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            globalData.userProgress[currentSubjectKey].total++;

            if (isExamMode) {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©ØŒ ÙÙ‚Ø· Ø³Ø¬Ù„Ù‡Ø§ ÙˆØ§Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
                if (userAnswer === currentQ.a) {
                    examScore++;
                    globalData.userProgress[currentSubjectKey].correct++;
                    playQuizSound('correct');
                } else {
                    globalData.userProgress[currentSubjectKey].wrong++;
                    playQuizSound('wrong');
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                db.collection('users').doc(currentUser.uid).set({ userProgress: globalData.userProgress }, { merge: true });
                
                currentQIndex++;
                loadQuestion();
                return;
            }

            // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„Ø´Ø±Ø­ ÙÙˆØ±Ø§Ù‹
            const feedbackDiv = document.getElementById('feedback');
            const controlsDiv = document.getElementById('controls');
            
            document.getElementById('options').style.display = 'none';
            feedbackDiv.style.display = 'block';
            controlsDiv.style.display = 'flex';
            controlsDiv.style.gap = '10px';

            if (userAnswer === currentQ.a) {
                globalData.userProgress[currentSubjectKey].correct++;
                playQuizSound('correct');
                feedbackDiv.className = 'feedback correct';
                feedbackDiv.innerHTML = `âœ… <strong>Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! (Correct)</strong> <br><br> ${currentQ.explanation || ''}`;
                document.getElementById('tryAgainBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                globalData.userProgress[currentSubjectKey].wrong++;
                playQuizSound('wrong');
                feedbackDiv.className = 'feedback wrong';
                feedbackDiv.innerHTML = `âŒ <strong>Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! (Wrong)</strong> <br><br> <strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ:</strong> ${currentQ.a} <br><br> ${currentQ.explanation || ''}`;
                document.getElementById('tryAgainBtn').style.display = 'inline-block';
                document.getElementById('nextBtn').style.display = 'none';
            }

            // Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            db.collection('users').doc(currentUser.uid).set({ userProgress: globalData.userProgress }, { merge: true });
        }

        // 5. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ù…Ø°Ø§ÙƒØ±Ø©
        function endExam() {
            clearInterval(examTimerInterval);
            const totalQs = questionsList.length;
            const percent = Math.round((examScore / totalQs) * 100);
            
            if (percent === 100) {
                // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø§Ø­ØªÙØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© 100%
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
            
            document.getElementById('finalScoreText').innerText = `${percent}%`;
            
            let message = "";
            if (percent >= 90) message = "Ø£Ø³Ø·ÙˆØ±Ø©! Ø£Ø¯Ø§Ø¤Ùƒ Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹ ğŸš€";
            else if (percent >= 70) message = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø£ÙƒØ«Ø± ğŸ’ª";
            else if (percent >= 50) message = "Ù†Ø¬Ø§Ø­ Ø¨ØµØ¹ÙˆØ¨Ø©.. ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ“š";
            else message = "Ù„Ù„Ø£Ø³Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¶Ø¹ÙŠÙØ©.. Ù„Ø§ ØªÙŠØ£Ø³ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ”";
            
            document.getElementById('examResultMessage').innerText = message;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('examResultScreen').classList.add('active');
        }

        function timerTick() {
            examTimeLeft--;
            updateTimerDisplay();
            if (examTimeLeft <= 0) {
                clearInterval(examTimerInterval);
                alert(t('js_timeUp'));
                endExam();
            }
        }

        function updateTimerDisplay() {
            let m = Math.floor(examTimeLeft / 60);
            let s = examTimeLeft % 60;
            document.getElementById('examTimerText').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }

        function cancelExam() {
            clearInterval(examTimerInterval);
            window.location.href = 'lecture.html';
        }

        function nextQuestion() { currentQIndex++; loadQuestion(); }
        function prevQuestion() { if (currentQIndex > 0) { currentQIndex--; loadQuestion(); } }
        function nextQuestionNav() { if (currentQIndex < questionsList.length - 1) { currentQIndex++; loadQuestion(); } }
        function jumpToQuestion(index) { currentQIndex = parseInt(index); loadQuestion(); }
        function tryAgain() { 
            document.getElementById('feedback').style.display = 'none'; 
            document.getElementById('controls').style.display = 'none'; 
            document.getElementById('options').style.display = 'block'; 
        }

        // 6. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        function askExternalAI(platform) {
            const currentQ = questionsList[currentQIndex];
            if(!currentQ) return;
            
            const promptText = currentLang === 'ar' 
                ? `Ø§Ø´Ø±Ø­Ù„ÙŠ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¯Ù‡ Ø¨Ø§Ù„ØªÙØµÙŠÙ„:\n\nØ§Ù„Ø³Ø¤Ø§Ù„:\n${currentQ.q}\n\nØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:\n${currentQ.a}` 
                : `Explain the answer to this question in detail:\n\nQuestion:\n${currentQ.q}\n\nCorrect Answer:\n${currentQ.a}`;
            
            navigator.clipboard.writeText(promptText).then(() => {
                showToast(t('js_copied'));
                setTimeout(() => {
                    if(platform === 'chatgpt') window.open('https://chatgpt.com/', '_blank');
                    if(platform === 'gemini') window.open('https://gemini.google.com/app', '_blank');
                }, 1200);
            });
        }

        // 7. Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª
        function updateSoundBtnUI() {
            const btn = document.getElementById('soundToggleBtn');
            if(btn) {
                btn.innerHTML = isSoundEnabled 
                    ? (currentLang === 'ar' ? 'ğŸ”Š Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„' : 'ğŸ”Š Sound On') 
                    : (currentLang === 'ar' ? 'ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…' : 'ğŸ”‡ Sound Off');
            }
        }

        function toggleQuizSound() {
            isSoundEnabled = !isSoundEnabled;
            localStorage.setItem('myUniversityApp_sound', isSoundEnabled ? 'enabled' : 'disabled');
            updateSoundBtnUI();
            showToast(isSoundEnabled ? (currentLang === 'ar' ? 'ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š' : 'Sound On ğŸ”Š') : (currentLang === 'ar' ? 'ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª ğŸ”‡' : 'Sound Off ğŸ”‡'));
        }

        function playQuizSound(type) {
            if (!isSoundEnabled) return;
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                if (type === 'correct') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.25);
                }
            } catch(e) { console.error("Audio error", e); }
        }
    </script>
</body>
</html>