<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaker - Lectures</title>
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa+Ink:wght@400;700&family=Cairo:wght@400;700;900&family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
</head>
<body data-theme="dark">

    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="margin: 0; padding: 8px 15px;">ğŸ”™ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h1 class="logo" data-i18n="appName" style="font-size: 2rem;">Ø°Ø§ÙƒØ±</h1>
        </div>
        <div class="header-controls">
            <div class="settings-group">
                <button class="icon-btn" onclick="toggleLanguage()" title="Language">ğŸŒ</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Theme">ğŸŒ™</button>
            </div>
            <div id="userProfile" class="hidden user-profile-badge">
                <img id="userImg" src="">
                <span id="userName"></span>
                <button onclick="logout()" class="btn-logout">ğŸšª</button>
            </div>
        </div>
    </div>

    <div id="lecturesScreen" class="screen active">
        <div class="top-controls" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="subjectTitle" style="color: var(--primary-color); border-bottom: 3px solid; padding-bottom: 10px; margin: 0;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <button class="btn btn-success" onclick="addLecture()" data-i18n="addLectureBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        
        <div class="dashboard" style="margin-top: 20px;">
            <h2 style="margin-top: 0; color: var(--primary-color);" data-i18n="statsTitle">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ù„Ùƒ ÙÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¯ÙŠ</h2>
            <div class="stats-grid">
                <div class="stat-box"><h4 data-i18n="statTotal">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙŒØ¬Ø§Ø¨Ø©</h4><span id="statTotal">0</span></div>
                <div class="stat-box"><h4 data-i18n="statCorrect">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø© âœ…</h4><span id="statCorrect" class="stat-correct">0</span></div>
                <div class="stat-box"><h4 data-i18n="statWrong">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø© âŒ</h4><span id="statWrong" class="stat-wrong">0</span></div>
                <div class="stat-box"><h4 data-i18n="statPercent">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ğŸ¯</h4><span id="statPercent">0%</span></div>
            </div>
            <div style="text-align: left; margin-top: 15px;">
                <button class="btn btn-danger" onclick="resetProgress()" data-i18n="resetStatsBtn">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            </div>
        </div>
        <div class="card-container" id="lecturesList" style="margin-top: 30px;"></div>
    </div>

    <div id="lectureDashboardScreen" class="screen">
        <button class="btn btn-secondary" onclick="showScreen('lecturesScreen')" style="margin-bottom: 20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
        <h2 id="lectureTitle" style="color: var(--primary-color); border-bottom: 3px solid; padding-bottom: 10px; display: inline-block;">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</h2>
        
        <div class="card-container" style="margin-top: 30px;">
            <div class="card" onclick="goToQuiz(false)">
                <h3 data-i18n="openStudyTitle">ğŸ“ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©</h3>
                <p data-i18n="openStudyDesc">Ø­Ù„ Ø¨Ø±Ø§Ø­ØªÙƒ ÙˆØ´ÙˆÙ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø´Ø±Ø­ ÙÙˆØ±Ø§Ù‹</p>
            </div>
            <div class="card" onclick="goToQuiz(true)" style="border-color: var(--danger-color);">
                <h3 style="color: var(--danger-color);" data-i18n="examModeTitle">â±ï¸ Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„ÙØ§ÙŠÙ†Ø§Ù„</h3>
                <p data-i18n="examModeDesc">Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ØŒ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¢Ø®Ø±</p>
            </div>
            <div class="card" onclick="openAddQuestion()" style="border-color: var(--success-color);">
                <h3 style="color: var(--success-color);" data-i18n="addQsBtn">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</h3>
                <p>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù…ÙØ±Ø¯Ø© Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            </div>
            <div class="card" onclick="openManageQuestions()" style="border-color: #f39c12;">
                <h3 style="color: #f39c12;" data-i18n="manageQsBtn">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                <p>ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
            </div>
        </div>
    </div>

    <div id="addQuestionScreen" class="screen">
        <button class="btn btn-secondary" onclick="showScreen('lectureDashboardScreen')" style="margin-bottom: 20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
        <div class="form-container">
            <h2 style="color: var(--primary-color);"><span data-i18n="addQsTitle">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</span> <span id="addQSubjectName" style="font-size: 1rem; opacity:0.8;"></span></h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="btn btn-secondary" id="btnSingleMode" onclick="toggleAddMode('single')" style="flex: 1; background-color: var(--primary-color);" data-i18n="singleModeBtn">Ø¥Ø¶Ø§ÙØ© Ù…ÙØ±Ø¯ âœï¸</button>
                <button class="btn btn-secondary" id="btnBulkMode" onclick="toggleAddMode('bulk')" style="flex: 1;" data-i18n="bulkModeBtn">Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ AI ğŸš€</button>
            </div>

            <div id="singleAddMode">
                <div class="form-group"><label data-i18n="qTypeLabel">Ø§Ù„Ù†ÙˆØ¹:</label><select id="qType" onchange="toggleFormFields()"><option value="tf">ØµØ­ ÙˆØ®Ø·Ø£</option><option value="mcq">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</option></select></div>
                <div class="form-group"><label data-i18n="qTextLabel">Ø§Ù„Ø³Ø¤Ø§Ù„:</label><textarea id="qText" rows="3"></textarea></div>
                <div id="mcqFields" class="hidden">
                    <div class="form-group"><label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (1):</label><input type="text" id="opt1"></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ (2):</label><input type="text" id="opt2"></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø« (3):</label><input type="text" id="opt3"></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹ (4):</label><input type="text" id="opt4"></div>
                </div>
                <div class="form-group"><label data-i18n="correctAnswerLabel">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label><select id="qAnswer" style="font-weight: bold;"></select></div>
                <div class="form-group"><label data-i18n="explanationLabel">Ø§Ù„Ø´Ø±Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><textarea id="qExplanation" rows="2"></textarea></div>
                <button class="btn btn-success" onclick="saveQuestion()" style="width: 100%;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </div>

            <div id="bulkAddMode" class="hidden">
                <div style="background: rgba(99, 102, 241, 0.05); border: 2px dashed var(--primary-color); padding: 25px; border-radius: 15px; margin-bottom: 30px;" id="dropZone">
                    <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 15px;">ğŸ¤– Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ (AI Prompt)</h3>
                    <p style="font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6;">
                        Ø­Ø· Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ù‡Ù†Ø§ØŒ Ø£Ùˆ Ø§Ø®ØªØ§Ø± Ù…Ù„Ù (PDF, Word, TXT) Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø±Ø¬ Ù†ØµÙ‡.
                    </p>
                    
                    <div style="margin-bottom: 15px; text-align: center;">
                        <input type="file" id="fileInput" accept=".txt,.pdf,.docx" style="display: none;" onchange="handleFileUpload(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="background-color: #3b82f6; width: 100%;">ğŸ“‚ Ø§Ø®ØªØ± Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² (PDF, Word, TXT)</button>
                    </div>

                    <textarea id="aiSourceText" rows="5" placeholder="Ø£Ùˆ Ø§Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©..."></textarea>
                    
                    <div style="display: flex; gap: 15px; margin-top: 15px;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                            <input type="number" id="aiQCount" value="10" min="1" max="50">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                            <select id="aiQType">
                                <option value="mcq">Ø§Ø®ØªÙŠØ§Ø±ÙŠ (MCQ)</option>
                                <option value="tf">ØµØ­ ÙˆØ®Ø·Ø£ (T/F)</option>
                                <option value="mixed">Ù…ÙŠÙƒØ³ (Ø§Ù„Ù†ÙˆØ¹ÙŠÙ†)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateAIPrompt()" style="width: 100%; margin-top: 20px;">ğŸª„ ØªÙˆÙ„ÙŠØ¯ ÙˆÙ†Ø³Ø® Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø³Ø±ÙŠ</button>
                    
                    <div id="aiActionButtons" style="display: none; gap: 10px; margin-top: 15px;">
                        <button class="btn" style="flex: 1; background-color: #10a37f;" onclick="window.open('https://chatgpt.com/', '_blank')">ğŸ§  ChatGPT</button>
                        <button class="btn" style="flex: 1; background-color: #8e44ad;" onclick="window.open('https://gemini.google.com/app', '_blank')">âœ¨ Gemini</button>
                    </div>
                </div>

                <div class="form-group" style="text-align: right;">
                    <h3 style="color: var(--text-color); margin-top: 0; margin-bottom: 15px;">ğŸ“¥ Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</h3>
                    <textarea id="bulkText" rows="8" placeholder="Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙƒØªØ¨Ù„Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ ÙƒÙ„Ù‡Ø§ ÙˆØ§Ø±Ù…ÙŠÙ‡Ø§ Ù‡Ù†Ø§ ÙˆØ¯ÙˆØ³ Ø­ÙØ¸..."></textarea>
                </div>
                <button class="btn btn-success" onclick="saveBulkQuestions()" style="width: 100%;">âš¡ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
            </div>
        </div>
    </div>

    <div id="manageQuestionsScreen" class="screen">
        <button class="btn btn-secondary" onclick="showScreen('lectureDashboardScreen')" style="margin-bottom: 20px;">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
        <div class="quiz-container" style="max-width: 900px;">
            <h2 style="color: var(--primary-color);" data-i18n="manageQsTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
            <div id="questionsListContainer" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmMessage" style="color: var(--text-color); margin-bottom: 25px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</h3>
            <div style="display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-secondary" onclick="closeConfirm()" data-i18n="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-danger" id="confirmBtnYes" data-i18n="agreeBtn">Ù…ÙˆØ§ÙÙ‚ âœ…</button>
            </div>
        </div>
    </div>
    <div id="promptModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="promptMessage" style="color: var(--text-color); margin-bottom: 15px;">...</h3>
            <input type="text" id="promptInput">
            <div style="display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-secondary" onclick="closePrompt()" data-i18n="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-success" id="promptBtnYes" data-i18n="saveBtn">Ø­ÙØ¸ ğŸ’¾</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <script src="app.js"></script>
    
    <script>
        let currentSubjectKey = localStorage.getItem('currentSubjectKey');
        let currentSubjectName = localStorage.getItem('currentSubjectName');
        let currentLectureName = '';
        let editingQuestionIndex = -1;

        if (!currentSubjectKey) {
            window.location.href = 'index.html'; // Ø·Ø±Ø¯ Ù„Ùˆ Ù…ÙÙŠØ´ Ù…Ø§Ø¯Ø© Ù…ØªØ­Ø¯Ø¯Ø©
        }

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userImg').src = user.photoURL;
                document.getElementById('userName').innerText = user.displayName.split(' ')[0];
                document.getElementById('subjectTitle').innerText = currentSubjectName;

                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists) {
                        globalData = doc.data();
                        if(!globalData.allData) globalData.allData = {};
                        if(!globalData.userProgress) globalData.userProgress = {};
                        if(!globalData.allData[currentSubjectKey]) globalData.allData[currentSubjectKey] = {};
                    }
                    updateDashboardUI();
                    renderLectures();
                } catch (e) {
                    console.error("Error loading data", e);
                }
            } else {
                window.location.href = 'index.html'; // Ø·Ø±Ø¯ Ù„Ùˆ Ù…Ø´ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
            }
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        // ================= Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª =================
        function initSubjectProgress() { 
            if (!globalData.userProgress[currentSubjectKey]) {
                globalData.userProgress[currentSubjectKey] = { total: 0, correct: 0, wrong: 0 }; 
            }
        }

        function updateDashboardUI() { 
            initSubjectProgress(); 
            let prog = globalData.userProgress[currentSubjectKey]; 
            document.getElementById('statTotal').innerText = prog.total; 
            document.getElementById('statCorrect').innerText = prog.correct; 
            document.getElementById('statWrong').innerText = prog.wrong; 
            document.getElementById('statPercent').innerText = (prog.total === 0 ? 0 : Math.round((prog.correct / prog.total) * 100)) + '%'; 
        }

        function resetProgress() { 
            customConfirm("Ù…ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¹Ø§ÙŠØ² ØªØµÙØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø¯ÙŠØŸ", async function() { 
                globalData.userProgress[currentSubjectKey] = { total: 0, correct: 0, wrong: 0 }; 
                await db.collection('users').doc(currentUser.uid).set({ userProgress: globalData.userProgress }, { merge: true });
                updateDashboardUI(); 
                showToast("ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
            }); 
        }

        function renderLectures() {
            const container = document.getElementById('lecturesList'); 
            container.innerHTML = ''; 
            const lectures = globalData.allData[currentSubjectKey];
            
            if (!lectures || Object.keys(lectures).length === 0) {
                container.innerHTML = `<p style="text-align:center; width:100%; opacity:0.7;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª.. Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø¯Ø¡.</p>`;
                return;
            }
            
            for(let lecName in lectures) { 
                container.innerHTML += `
                <div class="card" onclick="openLectureDashboard('${lecName}')" style="position: relative;">
                    <div style="position: absolute; top: 10px; left: 10px;" onclick="event.stopPropagation();">
                        <button onclick="editLecture('${lecName}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">âœï¸</button>
                        <button onclick="deleteLecture('${lecName}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">ğŸ—‘ï¸</button>
                    </div>
                    <h3>ğŸ“ ${lecName}</h3>
                    <p style="font-size: 1.1rem; font-weight: bold; margin-top: 10px; color: var(--text-color);">Ø£Ø³Ø¦Ù„Ø©: ${lectures[lecName].length}</p>
                </div>`; 
            }
        }

        function addLecture() { 
            customPrompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", "", async function(lecName) { 
                if(lecName && lecName.trim() !== "") { 
                    lecName = sanitizeInput(lecName.trim()); 
                    if(!globalData.allData[currentSubjectKey][lecName]) { 
                        globalData.allData[currentSubjectKey][lecName] = []; 
                        await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
                        renderLectures(); 
                    } 
                } 
            }); 
        }

        function editLecture(oldName) { 
            customPrompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldName, async function(newName) { 
                if (newName && newName.trim() !== "" && newName !== oldName) { 
                    newName = sanitizeInput(newName.trim()); 
                    globalData.allData[currentSubjectKey][newName] = globalData.allData[currentSubjectKey][oldName]; 
                    delete globalData.allData[currentSubjectKey][oldName]; 
                    await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
                    renderLectures(); 
                } 
            }); 
        }

        function deleteLecture(lecName) { 
            customConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ÙƒÙ„ Ø£Ø³Ø¦Ù„ØªÙ‡Ø§ØŸ", async function() { 
                delete globalData.allData[currentSubjectKey][lecName]; 
                await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
                renderLectures(); 
                showToast("ØªÙ… Ø§Ù„Ù…Ø³Ø­"); 
            }); 
        }

        function openLectureDashboard(lecName) {
            currentLectureName = lecName;
            document.getElementById('lectureTitle').innerText = `${currentSubjectName} - ${lecName}`;
            document.getElementById('addQSubjectName').innerText = `(${lecName})`;
            showScreen('lectureDashboardScreen');
        }

        // ================= Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© =================
        function toggleAddMode(mode) { 
            if(mode === 'single') { 
                document.getElementById('singleAddMode').classList.remove('hidden'); 
                document.getElementById('bulkAddMode').classList.add('hidden'); 
                document.getElementById('btnSingleMode').style.backgroundColor = 'var(--primary-color)'; 
                document.getElementById('btnBulkMode').style.backgroundColor = 'var(--secondary-color)'; 
            } else { 
                document.getElementById('singleAddMode').classList.add('hidden'); 
                document.getElementById('bulkAddMode').classList.remove('hidden'); 
                document.getElementById('btnSingleMode').style.backgroundColor = 'var(--secondary-color)'; 
                document.getElementById('btnBulkMode').style.backgroundColor = 'var(--primary-color)'; 
            } 
        }

        function toggleFormFields() { 
            const type = document.getElementById('qType').value; 
            const mcqFields = document.getElementById('mcqFields'); 
            const qAns = document.getElementById('qAnswer'); 
            qAns.innerHTML = ''; 
            if (type === 'mcq') { 
                mcqFields.classList.remove('hidden'); 
                qAns.innerHTML = `<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>`; 
            } else { 
                mcqFields.classList.add('hidden'); 
                qAns.innerHTML = `<option value="ØµØ­">ØµØ­</option><option value="ØºÙ„Ø·">ØºÙ„Ø·</option>`; 
            } 
        }

        function openAddQuestion() {
            editingQuestionIndex = -1;
            document.getElementById('qType').value = 'tf'; toggleFormFields();
            document.getElementById('qText').value = ''; document.getElementById('qExplanation').value = '';
            document.getElementById('opt1').value = ''; document.getElementById('opt2').value = '';
            document.getElementById('opt3').value = ''; document.getElementById('opt4').value = '';
            toggleAddMode('single');
            showScreen('addQuestionScreen');
        }

        async function saveQuestion() {
            const type = document.getElementById('qType').value; 
            const q = sanitizeInput(document.getElementById('qText').value.trim()); 
            const exp = sanitizeInput(document.getElementById('qExplanation').value.trim());
            
            if(!q) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„!"); 
            
            let newQ = { type, q, explanation: exp }; 
            let correctAns = "";
            
            if (type === 'mcq') { 
                const o1 = sanitizeInput(document.getElementById('opt1').value.trim()); 
                const o2 = sanitizeInput(document.getElementById('opt2').value.trim()); 
                const o3 = sanitizeInput(document.getElementById('opt3').value.trim()); 
                const o4 = sanitizeInput(document.getElementById('opt4').value.trim()); 
                newQ.options = [o1, o2]; if(o3) newQ.options.push(o3); if(o4) newQ.options.push(o4); 
                const ansIndex = document.getElementById('qAnswer').value; 
                if (ansIndex === '1') correctAns = o1; else if (ansIndex === '2') correctAns = o2; else if (ansIndex === '3' && o3) correctAns = o3; else if (ansIndex === '4' && o4) correctAns = o4; 
                newQ.a = correctAns; 
            } else { 
                newQ.a = document.getElementById('qAnswer').value; 
            }
            
            if (editingQuestionIndex > -1) { 
                globalData.allData[currentSubjectKey][currentLectureName][editingQuestionIndex] = newQ; 
            } else { 
                globalData.allData[currentSubjectKey][currentLectureName].push(newQ); 
            }
            
            await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„"); 
            renderLectures(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø±Ø©
            showScreen('lectureDashboardScreen');
        }

        // ================= Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¨Ø§Ù„Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø³Ø­Ø¨) =================
        async function handleFileUpload(event) {
            const file = event.target.files ? event.target.files[0] : (event.dataTransfer ? event.dataTransfer.files[0] : null);
            if(!file) return;

            const fileName = file.name.toLowerCase();
            const aiTextarea = document.getElementById('aiSourceText');
            showToast('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù... â³');

            if (fileName.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = e => { aiTextarea.value = e.target.result; showToast('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ! âœ…'); };
                reader.readAsText(file);
            } 
            else if (fileName.endsWith('.pdf')) {
                const reader = new FileReader();
                reader.onload = async function() {
                    try {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await window.pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        aiTextarea.value = fullText;
                        showToast('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù€ PDF! âœ…');
                    } catch(err) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù€ PDF. Ø¬Ø±Ø¨ Ù…Ù„Ù Ø¢Ø®Ø±."); }
                };
                reader.readAsArrayBuffer(file);
            }
            else if (fileName.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(result => { aiTextarea.value = result.value; showToast('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙˆÙˆØ±Ø¯! âœ…'); })
                        .catch(err => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ÙˆÙˆØ±Ø¯."));
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± TXT Ø£Ùˆ PDF Ø£Ùˆ DOCX.');
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        const dropZone = document.getElementById('dropZone');
        if(dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.style.backgroundColor = 'rgba(16, 185, 129, 0.1)', false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.style.backgroundColor = 'rgba(99, 102, 241, 0.05)', false);
            });
            dropZone.addEventListener('drop', handleFileUpload, false);
        }

        function generateAIPrompt() {
            const sourceText = document.getElementById('aiSourceText').value.trim(); 
            const qCount = document.getElementById('aiQCount').value; 
            const qType = document.getElementById('aiQType').value;
            if (!sourceText) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹!");
            
            let typeInstruction = "";
            if (qType === "mcq") typeInstruction = "ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙƒÙˆÙ† Ø§Ø®ØªÙŠØ§Ø±ÙŠ (MCQ). Ø§Ù„ØµÙŠØºØ©:\n[Ø§Ù„Ø³Ø¤Ø§Ù„]\n[Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 1]\n[Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 2]\n[Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 3]\n[Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 4]\n[Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª]";
            else if (qType === "tf") typeInstruction = "ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØµØ­ ÙˆØ®Ø·Ø£. Ø§Ù„ØµÙŠØºØ©:\n[Ø§Ù„Ø³Ø¤Ø§Ù„]\n[ØµØ­ Ø£Ùˆ ØºÙ„Ø·] (Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© 'ØµØ­' Ø£Ùˆ 'ØºÙ„Ø·' ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ)";
            else typeInstruction = "Ù†Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆØ§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙŠ ØµØ­ ÙˆØ®Ø·Ø£ Ø¨Ù†ÙØ³ Ø§Ù„ØµÙŠØº Ø§Ù„ØµØ§Ø±Ù…Ø© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡.";
            
            const prompt = `Ø£Ù†Øª Ø£Ø³ØªØ§Ø° Ø¬Ø§Ù…Ø¹ÙŠ Ù…Ø­ØªØ±Ù. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ${qCount} Ø£Ø³Ø¦Ù„Ø©.\nØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØµØ§Ø±Ù…Ø© Ù„Ù„ØµÙŠØºØ© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ¨Ø¹Ù‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹:\n${typeInstruction}\n\n- ÙŠØ¬Ø¨ ØªØ±Ùƒ Ø³Ø·Ø± ÙØ§Ø±Øº ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨ÙŠÙ† ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø°ÙŠ ÙŠÙ„ÙŠÙ‡.\n- Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£Ùˆ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ø«Ù„ 1. Ø£Ùˆ Ø£-).\n- Ù„Ø§ ØªÙƒØªØ¨ Ø£ÙŠ Ù…Ù‚Ø¯Ù…Ø§Øª Ø£Ùˆ Ø®Ø§ØªÙ…Ø§ØªØŒ ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¹Ù„Ù…ÙŠ:\n"""\n${sourceText}\n"""`;
            
            navigator.clipboard.writeText(prompt).then(() => { 
                showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø³Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­! ğŸ“‹"); 
                document.getElementById('aiActionButtons').style.display = 'flex'; 
            }).catch(err => alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø­Ø§ÙˆÙ„ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.'));
        }

        async function saveBulkQuestions() {
            const text = document.getElementById('bulkText').value.trim(); 
            if(!text) return alert("Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙØ§Ø±Øº!");
            
            const blocks = text.split(/\n\s*\n/); 
            let added = 0;
            
            blocks.forEach(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(l => l !== ''); 
                if(lines.length < 2) return; 
                
                const q = sanitizeInput(lines[0]); 
                let a = sanitizeInput(lines[lines.length - 1]);
                
                if(lines.length === 2) { 
                    if(a === 'ØµØ­' || a === 'ØºÙ„Ø·' || a === 'True' || a === 'False') { 
                        globalData.allData[currentSubjectKey][currentLectureName].push({ type: 'tf', q: q, a: (a==='True'?'ØµØ­':(a==='False'?'ØºÙ„Ø·':a)), explanation: '' }); 
                        added++; 
                    } 
                } else if (lines.length > 2) { 
                    const options = lines.slice(1, lines.length - 1).map(opt => sanitizeInput(opt)); 
                    globalData.allData[currentSubjectKey][currentLectureName].push({ type: 'mcq', q: q, options: options, a: a, explanation: '' }); 
                    added++; 
                }
            });
            
            if(added > 0) { 
                await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
                showToast(`ØªÙ… Ø­ÙØ¸ ${added} Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸš€`); 
                document.getElementById('bulkText').value = ''; 
                renderLectures();
                showScreen('lectureDashboardScreen'); 
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙŠØºØ© ØµØ­ÙŠØ­Ø© Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù….");
            }
        }

        // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© =================
        function openManageQuestions() { 
            renderManageQuestions(); 
            showScreen('manageQuestionsScreen'); 
        }

        function renderManageQuestions() {
            const container = document.getElementById('questionsListContainer'); 
            container.innerHTML = ''; 
            const questions = globalData.allData[currentSubjectKey][currentLectureName];
            
            if(questions.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</p>";
                return;
            }

            questions.forEach((q, index) => {
                let optsHtml = q.type === 'mcq' ? `<div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;">${q.options.join(' | ')}</div>` : '';
                container.innerHTML += `
                <div style="background: var(--input-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--input-border); position: relative; text-align: right;">
                    <div style="position: absolute; top: 10px; left: 10px; direction: ltr;">
                        <button onclick="editQuestion(${index})" class="btn" style="padding: 5px 10px; font-size: 14px;">âœï¸</button>
                        <button onclick="deleteQuestion(${index})" class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;">ğŸ—‘ï¸</button>
                    </div>
                    <div style="padding-left: 90px;">
                        <strong>Q${index + 1}:</strong> ${q.q}
                        <div style="color: var(--success-color); margin-top: 5px;"><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong> ${q.a}</div>
                        ${optsHtml}
                    </div>
                </div>`;
            });
        }

        function deleteQuestion(index) { 
            customConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ", async function() { 
                globalData.allData[currentSubjectKey][currentLectureName].splice(index, 1); 
                await db.collection('users').doc(currentUser.uid).set({ allData: globalData.allData }, { merge: true });
                renderManageQuestions(); 
                renderLectures();
            }); 
        }

        function editQuestion(index) { 
            editingQuestionIndex = index; 
            const qToEdit = globalData.allData[currentSubjectKey][currentLectureName][index]; 
            document.getElementById('qType').value = qToEdit.type; 
            toggleFormFields(); 
            document.getElementById('qText').value = qToEdit.q; 
            document.getElementById('qExplanation').value = qToEdit.explanation || ''; 
            
            if (qToEdit.type === 'mcq') { 
                document.getElementById('opt1').value = qToEdit.options[0] || ''; 
                document.getElementById('opt2').value = qToEdit.options[1] || ''; 
                document.getElementById('opt3').value = qToEdit.options[2] || ''; 
                document.getElementById('opt4').value = qToEdit.options[3] || ''; 
                let matchIndex = '1'; 
                if (qToEdit.options[1] === qToEdit.a) matchIndex = '2'; 
                else if (qToEdit.options[2] === qToEdit.a) matchIndex = '3'; 
                else if (qToEdit.options[3] === qToEdit.a) matchIndex = '4';
                document.getElementById('qAnswer').value = matchIndex;
            } else { 
                document.getElementById('qAnswer').value = qToEdit.a; 
            } 
            toggleAddMode('single'); 
            showScreen('addQuestionScreen'); 
        }

        // ================= Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† =================
        function goToQuiz(isExamMode) {
            const questions = globalData.allData[currentSubjectKey][currentLectureName];
            if (!questions || questions.length === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©. Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            localStorage.setItem('currentLectureName', currentLectureName);
            localStorage.setItem('isExamMode', isExamMode);
            window.location.href = 'quiz.html'; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©
        }
    </script>
</body>
</html>